version: "3.8"

services:
  # Backend service
  backend:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: v0-backend
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
      - MATTERMOST_URL=${MATTERMOST_URL}
      - MATTERMOST_BOT_TOKEN=${MATTERMOST_BOT_TOKEN}
      - MATTERMOST_WEBHOOK_SECRET=${MATTERMOST_WEBHOOK_SECRET}
      - MATTERMOST_TEAM_ID=${MATTERMOST_TEAM_ID}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - PORT=3000
      - HOST=0.0.0.0
      - DOCKER_IMAGE_NAME=claude-code-runner
      - WORKSPACE_VOLUME=/workspaces
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - claude-workspaces:/workspaces
    restart: unless-stopped
    networks:
      - v0-network

  # Nginx reverse proxy with basic auth
  nginx:
    image: nginx:alpine
    container_name: v0-nginx
    ports:
      - "80:80"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/.htpasswd:/etc/nginx/.htpasswd:ro
      - nginx-logs:/var/log/nginx
    depends_on:
      - mattermost
    restart: unless-stopped
    networks:
      - v0-network

  # Mattermost (optional - if you want to run your own instance)
  mattermost:
    image: mattermost/mattermost-team-edition:latest
    container_name: v0-mattermost
    expose:
      - "8065"
      - "3000"
    environment:
      - MM_SQLSETTINGS_DRIVERNAME=postgres
      - MM_SQLSETTINGS_DATASOURCE=postgres://mmuser:mmuser_password@postgres:5432/mattermost?sslmode=disable&connect_timeout=10
      - MM_SERVICESETTINGS_SITEURL=http://localhost:8065
    volumes:
      - mattermost-config:/mattermost/config
      - mattermost-data:/mattermost/data
      - mattermost-logs:/mattermost/logs
      - mattermost-plugins:/mattermost/plugins
    depends_on:
      - postgres
    restart: unless-stopped
    networks:
      - v0-network

  # PostgreSQL for Mattermost
  postgres:
    image: postgres:14-alpine
    container_name: v0-postgres
    environment:
      - POSTGRES_USER=mmuser
      - POSTGRES_PASSWORD=mmuser_password
      - POSTGRES_DB=mattermost
    volumes:
      - postgres-data:/var/lib/postgresql/data
    restart: unless-stopped
    networks:
      - v0-network

volumes:
  claude-workspaces:
    driver: local
  nginx-logs:
    driver: local
  mattermost-config:
    driver: local
  mattermost-data:
    driver: local
  mattermost-logs:
    driver: local
  mattermost-plugins:
    driver: local
  postgres-data:
    driver: local

networks:
  v0-network:
    driver: bridge
